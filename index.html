<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ø³Ø¬Ù„ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ â€“ Ù†Ø³Ø®Ø© ØªØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª</title>
<style>
  :root{
    --bg:#fff7ed; /* orange-50 */
    --panel:#ffffff;
    --ink:#1f2937;
    --muted:#6b7280;
    --primary:#f97316; /* orange-500 */
    --primary-600:#ea580c;
    --green:#10b981;
    --emerald:#059669;
    --yellow:#f59e0b;
    --red:#ef4444;
    --purple:#7c3aed;
    --purple-100:#ede9fe;
    --gray-100:#f3f4f6;
    --gray-200:#e5e7eb;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Cairo",Arial; background:var(--bg); color:var(--ink)}
  h1,h2,h3{margin:0 0 .5rem}
  .container{max-width:1100px;margin:0 auto;padding:16px}
  .card{background:var(--panel);border:1px solid var(--gray-200);border-radius:14px;padding:16px; box-shadow:0 8px 20px rgba(0,0,0,.06)}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .btn{border:0;border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:700}
  .btn.primary{background:var(--primary);color:#fff}
  .btn.secondary{background:#6366f1;color:#fff}
  .btn.green{background:var(--green);color:#fff}
  .btn.gray{background:#6b7280;color:#fff}
  .btn.red{background:var(--red);color:#fff}
  .btn.yellow{background:var(--yellow);color:#000}
  .btn.small{padding:6px 10px;font-size:14px;border-radius:8px}
  .input,select{padding:10px 12px;border:1px solid var(--gray-200);border-radius:10px;outline:0}
  .input:focus,select:focus{border-color:var(--primary)}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{border:1px solid var(--gray-200);padding:10px;text-align:right}
  .table thead th{background:#e0f2fe}
  .badge{display:inline-flex;align-items:center;gap:8px;background:var(--gray-100);border:1px solid var(--gray-200);border-radius:999px;padding:6px 10px;color:#065f46}
  .statGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px}
  .stat{background:#fff;border:1px solid var(--gray-200);border-radius:12px;padding:12px;text-align:center}
  .progress{width:100%;height:10px;background:var(--gray-200);border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0;transition:width .35s ease;border-radius:999px}
  .bar.purple{background:var(--purple)}
  .bar.green{background:var(--emerald)}
  .bar.yellow{background:var(--yellow)}
  .bar.red{background:var(--red)}
  .sectionTitle{font-weight:800;color:#1f2937;margin:16px 0 8px}
  .muted{color:var(--muted);font-size:14px}
  .center{text-align:center}
  .hidden{display:none}
  .pill{background:#fff7ed;border:1px dashed var(--primary);padding:8px 10px;border-radius:10px}
  .footer{font-size:12px;color:#6b7280;text-align:center;margin:18px 0}
  @media print{
    .no-print{display:none !important}
    body{background:#fff}
    .card{border:2px solid #000; box-shadow:none; border-radius:0}
    .print-table th,.print-table td{border:2px solid #000 !important}
  }
</style>
</head>
<body>
<div class="container">
  <div id="loginView" class="card">
    <div class="center">
      <div style="font-size:42px">ğŸ«</div>
      <h1>Ø³Ø¬Ù„ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h1>
      <div class="muted">âœ¨ ÙÙƒØ±Ø© Ø§Ù„Ù…Ø¹Ù„Ù…Ø© ÙØ§Ø·Ù…Ø© Ù‡Ø²Ø§Ø²ÙŠ âœ¨</div>
    </div>
    <div style="height:12px"></div>
    <div class="row">
      <label style="min-width:120px">ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
      <input id="phone" class="input" placeholder="05xxxxxxxx" dir="ltr" style="flex:1" />
    </div>
    <div class="row" style="margin-top:8px">
      <label style="min-width:120px">ğŸ”’ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
      <input id="password" class="input" type="password" placeholder="â€¢â€¢â€¢â€¢" style="flex:1" />
    </div>
    <div class="row" style="margin-top:12px;justify-content:space-between">
      <button id="loginBtn" class="btn primary" style="flex:1">ğŸ”‘ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
      <button id="registerBtn" class="btn secondary" style="flex:1">Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ØŸ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
    </div>
    <div class="muted center" style="margin-top:10px">ğŸ”’ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙØ­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²</div>
  </div>

  <div id="appView" class="hidden">
    <div class="card row" style="justify-content:space-between">
      <div class="row">
        <div style="font-size:26px">ğŸ‘¤</div>
        <div>
          <div style="font-weight:800" id="welcome"></div>
          <div class="muted">ğŸ’¾ Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ø­Ù„ÙŠ - Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²</div>
        </div>
      </div>
      <button id="logoutBtn" class="btn red">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>

    <div style="height:12px"></div>

    <div class="card">
      <div class="center">
        <h2>Ø³Ø¬Ù„ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</h2>
        <div class="pill">Ù†Ø¸Ø§Ù… Ù„Ø¥Ø¯Ø§Ø±Ø© Ø£Ù†Ù…Ø§Ø· Ø§Ù„ØªØ¹Ù„Ù… ÙˆØ§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ</div>
      </div>

      <div style="height:10px"></div>
      <div class="row no-print">
        <button id="btnImportJSON" class="btn secondary small">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)</button>
        <input id="fileJSON" type="file" accept=".json" class="hidden"/>
        <button id="btnSaveJSON" class="btn green small">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        <button id="btnSaveTxt" class="btn small" style="background:#9333ea;color:#fff">ğŸ“„ Ø­ÙØ¸ Ù†ØµÙŠ</button>
        <button id="btnPrint" class="btn primary small">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© PDF</button>
        <input id="search" class="input" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…..." style="margin-right:auto; min-width:230px"/>
        <button id="allPresent" class="btn green small">âœ… Ø§Ù„ÙƒÙ„ Ø­Ø§Ø¶Ø±</button>
        <button id="allAbsent" class="btn red small">âŒ Ø§Ù„ÙƒÙ„ ØºØ§Ø¦Ø¨</button>
      </div>

      <div style="height:8px"></div>
      <div class="row">
        <select id="grade" class="input">
          <option value="">ğŸ“ -- Ø§Ø®ØªØ± Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ --</option>
        </select>
        <input id="subject" class="input" placeholder="Ø§Ù„Ù…Ø§Ø¯Ø© (Ù…Ø«Ø§Ù„: Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª)"/>
        <input id="teacher" class="input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…/Ø§Ù„Ù…Ø¹Ù„Ù…Ø© (Ù…Ø«Ø§Ù„: Ø£/ ÙØ§Ø·Ù…Ø© Ù‡Ø²Ø§Ø²ÙŠ)"/>
      </div>
      <div id="gradeBadge" class="center" style="margin-top:10px"></div>
    </div>

    <div style="height:12px"></div>

    <div class="card no-print">
      <h3 class="sectionTitle">Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
      <div class="row">
        <input id="newName" class="input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨"/>
        <button id="addBtn" class="btn primary">â• Ø¥Ø¶Ø§ÙØ©</button>
      </div>
    </div>

    <div style="height:12px"></div>
    <div class="card">
      <div class="tableWrap">
        <table class="table print-table" id="studentsTable" aria-label="Students Table">
          <thead>
            <tr>
              <th>#</th>
              <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨/Ø©</th>
              <th>Ù†Ù…Ø· Ø§Ù„Ù…ØªØ¹Ù„Ù…</th>
              <th>Ø§Ù„Ø­Ø¶ÙˆØ±</th>
              <th>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø·Ø§Ù„Ø¨</th>
              <th class="no-print center">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <div style="height:12px"></div>
    <div id="quickStats" class="statGrid"></div>

    <div style="height:12px"></div>
    <div class="card">
      <h3 class="sectionTitle center">Ø¥Ø­ØµØ§Ø¡Ø§Øª Ø£Ù†Ù…Ø§Ø· Ø§Ù„ØªØ¹Ù„Ù‘Ù…</h3>
      <div id="styleStats" class="statGrid"></div>
    </div>

    <div style="height:12px"></div>
    <div class="card">
      <h3 class="sectionTitle center">Ø¥Ø­ØµØ§Ø¡Ø§Øª Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
      <div id="levelStats" class="statGrid"></div>
    </div>

    <div class="footer no-print">
      Ø¨Ø±Ù…Ø¬Ø©: Ø£/ ÙØ§Ø·Ù…Ø© Ù‡Ø²Ø§Ø²ÙŠ â€“ Ù…Ù„ØªÙ‚Ù‰ Ù…Ø¹Ù„Ù…ÙŠ ÙˆÙ…Ø¹Ù„Ù…Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª â€¢ Ù…Ù„ØªÙ‚Ù‰ Ø§Ù„ØªØ¹Ù„ÙŠÙ… Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ
    </div>
  </div>
</div>

<script>
(function(){
  const gradeOptions = ['Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ','Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ','Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ','Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ','Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ','Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ','Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ù…ØªÙˆØ³Ø·','Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ù…ØªÙˆØ³Ø·','Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ù…ØªÙˆØ³Ø·','Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ','Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ','Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ'];
  const learningStyles = ['Ø¨ØµØ±ÙŠ','Ø³Ù…Ø¹ÙŠ','Ø­Ø±ÙƒÙŠ','Ù‚Ø±Ø§Ø¦ÙŠ/ÙƒØªØ§Ø¨ÙŠ','ØªÙØ§Ø¹Ù„ÙŠ','Ù…Ù†Ø·Ù‚ÙŠ'];
  const attendanceOptions = ['Ø­Ø§Ø¶Ø±','ØºØ§Ø¦Ø¨'];
  const levelOptions = ['Ø¯ÙˆÙ† Ø§Ù„Ù…ØªÙˆØ³Ø·','Ø¶Ù…Ù† Ø§Ù„Ù…ØªÙˆØ³Ø·','ÙÙˆÙ‚ Ø§Ù„Ù…ØªÙˆØ³Ø·'];

  const els = {
    loginView: document.getElementById('loginView'),
    appView: document.getElementById('appView'),
    phone: document.getElementById('phone'),
    password: document.getElementById('password'),
    loginBtn: document.getElementById('loginBtn'),
    registerBtn: document.getElementById('registerBtn'),
    welcome: document.getElementById('welcome'),
    logoutBtn: document.getElementById('logoutBtn'),
    grade: document.getElementById('grade'),
    subject: document.getElementById('subject'),
    teacher: document.getElementById('teacher'),
    gradeBadge: document.getElementById('gradeBadge'),
    newName: document.getElementById('newName'),
    addBtn: document.getElementById('addBtn'),
    tbody: document.getElementById('tbody'),
    quickStats: document.getElementById('quickStats'),
    styleStats: document.getElementById('styleStats'),
    levelStats: document.getElementById('levelStats'),
    btnImportJSON: document.getElementById('btnImportJSON'),
    fileJSON: document.getElementById('fileJSON'),
    btnSaveJSON: document.getElementById('btnSaveJSON'),
    btnSaveTxt: document.getElementById('btnSaveTxt'),
    btnPrint: document.getElementById('btnPrint'),
    search: document.getElementById('search'),
    allPresent: document.getElementById('allPresent'),
    allAbsent: document.getElementById('allAbsent'),
  };

  // Populate grade select
  gradeOptions.forEach(g => {
    const o = document.createElement('option');
    o.value = g; o.textContent = g;
    els.grade.appendChild(o);
  });

  // State
  const state = {
    currentUser: null,
    classInfo: { className: '', subject: '', teacherName: '' },
    students: [],
    searchQuery: ''
  };

  function saveUserData(){
    if(!state.currentUser) return;
    const key = 'userData_'+state.currentUser.phone;
    const data = { classInfo: state.classInfo, students: state.students };
    try{ localStorage.setItem(key, JSON.stringify(data)); }catch(e){}
  }

  function loadUserData(phone){
    const key = 'userData_'+phone;
    try{
      const raw = localStorage.getItem(key);
      if(!raw) return;
      const data = JSON.parse(raw);
      state.classInfo = data.classInfo || state.classInfo;
      state.students = Array.isArray(data.students) ? data.students : [];
    }catch(e){}
  }

  function showApp(){
    els.loginView.classList.add('hidden');
    els.appView.classList.remove('hidden');
    els.welcome.textContent = 'Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ '+state.currentUser.phone;
    // fill form with class info
    els.grade.value = state.classInfo.className || '';
    els.subject.value = state.classInfo.subject || '';
    els.teacher.value = state.classInfo.teacherName || '';
    render();
  }

  // Auth
  function tryAutoLogin(){
    const saved = localStorage.getItem('currentUser');
    if(!saved) return false;
    try{
      state.currentUser = JSON.parse(saved);
      loadUserData(state.currentUser.phone);
      showApp(); return true;
    }catch(e){ localStorage.removeItem('currentUser'); }
    return false;
  }

  function login(){
    const phone = els.phone.value.trim();
    const password = els.password.value.trim();
    if(phone.length < 10 || password.length < 4){ alert('Ø£Ø¯Ø®Ù„ÙŠ Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ 10 Ø®Ø§Ù†Ø§Øª ÙˆÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± 4 Ø®Ø§Ù†Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„'); return; }
    const users = JSON.parse(localStorage.getItem('users')||'[]');
    const u = users.find(x=>x.phone===phone && x.password===password);
    if(!u){ alert('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯.'); return; }
    state.currentUser = u;
    localStorage.setItem('currentUser', JSON.stringify(u));
    loadUserData(u.phone);
    showApp();
  }

  function register(){
    const phone = els.phone.value.trim();
    const password = els.password.value.trim();
    if(phone.length < 10 || password.length < 4){ alert('Ø£Ø¯Ø®Ù„ÙŠ Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ 10 Ø®Ø§Ù†Ø§Øª ÙˆÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± 4 Ø®Ø§Ù†Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„'); return; }
    const users = JSON.parse(localStorage.getItem('users')||'[]');
    if(users.find(x=>x.phone===phone)){ alert('Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ù…Ø³Ø¬Ù‘Ù„ Ù…Ø³Ø¨Ù‚Ù‹Ø§. Ø³Ø¬Ù‘Ù„ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„.'); return; }
    const u = { phone, password };
    users.push(u);
    localStorage.setItem('users', JSON.stringify(users));
    localStorage.setItem('currentUser', JSON.stringify(u));
    state.currentUser = u;
    loadUserData(u.phone);
    alert('âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!');
    showApp();
  }

  function logout(){
    saveUserData();
    localStorage.removeItem('currentUser');
    state.currentUser = null;
    els.appView.classList.add('hidden');
    els.loginView.classList.remove('hidden');
  }

  // Students ops
  function addStudent(){
    const name = els.newName.value.trim();
    if(!name) return;
    const s = {
      id: Date.now()+Math.random(),
      name,
      learningStyle: learningStyles[0],
      attendance: attendanceOptions[0],
      level: levelOptions[1]
    };
    state.students.push(s);
    els.newName.value = '';
    saveUserData();
    render();
  }

  function deleteStudent(id){
    state.students = state.students.filter(s=>s.id!==id);
    saveUserData();
    render();
  }

  function updateField(id, field, value){
    const s = state.students.find(s=>s.id===id);
    if(!s) return;
    s[field] = value;
    saveUserData();
    renderQuickStats(); // lightweight refresh
  }

  function setAllAttendance(v){
    state.students.forEach(s=>s.attendance=v);
    saveUserData();
    render();
  }

  // Class info ops
  els.grade.addEventListener('change', ()=>{ state.classInfo.className = els.grade.value; saveUserData(); render(); });
  els.subject.addEventListener('input', ()=>{ state.classInfo.subject = els.subject.value; saveUserData(); });
  els.teacher.addEventListener('input', ()=>{ state.classInfo.teacherName = els.teacher.value; saveUserData(); });

  // Export/Import/Print
  els.btnSaveJSON.addEventListener('click', ()=>{
    const data = {
      classInfo: state.classInfo,
      students: state.students,
      userPhone: state.currentUser?.phone,
      timestamp: new Date().toLocaleString('ar-SA')
    };
    const blob = new Blob(['\ufeff'+JSON.stringify(data,null,2)], {type:'application/json;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `Ø³Ø¬Ù„_Ø§Ù„Ø·Ù„Ø§Ø¨_${(state.classInfo.className||'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª').replace(/\s+/g,'_')}_${new Date().toLocaleDateString('ar-SA').replace(/\//g,'-')}.json`;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
  });

  els.btnSaveTxt.addEventListener('click', ()=>{
    const lines = [];
    lines.push('Ø³Ø¬Ù„ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ');
    lines.push('ÙÙƒØ±Ø© Ø§Ù„Ù…Ø¹Ù„Ù…Ø© ÙØ§Ø·Ù…Ø© Ù‡Ø²Ø§Ø²ÙŠ');
    lines.push('');
    lines.push('Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙ:');
    lines.push('Ø§Ù„ØµÙ: '+(state.classInfo.className||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'));
    lines.push('Ø§Ù„Ù…Ø§Ø¯Ø©: '+(state.classInfo.subject||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©'));
    lines.push('Ø§Ù„Ù…Ø¹Ù„Ù…/Ø©: '+(state.classInfo.teacherName||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'));
    lines.push('');
    lines.push('Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨:');
    state.students.forEach((s,i)=>{
      lines.push(`${i+1}. ${s.name}`);
      lines.push(`   - Ù†Ù…Ø· Ø§Ù„Ù…ØªØ¹Ù„Ù…: ${s.learningStyle}`);
      lines.push(`   - Ø§Ù„Ø­Ø¶ÙˆØ±: ${s.attendance}`);
      lines.push(`   - Ø§Ù„Ù…Ø³ØªÙˆÙ‰: ${s.level}`);
    });
    const blob = new Blob(['\ufeff'+lines.join('\n')],{type:'text/plain;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `Ø³Ø¬Ù„_Ù†ØµÙŠ_${(state.classInfo.className||'Ø§Ù„Ø·Ù„Ø§Ø¨').replace(/\s+/g,'_')}_${new Date().toLocaleDateString('ar-SA').replace(/\//g,'-')}.txt`;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
  });

  els.btnImportJSON.addEventListener('click', ()=> els.fileJSON.click());
  els.fileJSON.addEventListener('change', (ev)=>{
    const f = ev.target.files[0];
    if(!f) return;
    const fr = new FileReader();
    fr.onload = (e)=>{
      try{
        const data = JSON.parse(e.target.result);
        if(!data.students || !Array.isArray(data.students)) throw new Error('bad');
        state.classInfo = data.classInfo || state.classInfo;
        state.students = data.students;
        // refill UI
        els.grade.value = state.classInfo.className || '';
        els.subject.value = state.classInfo.subject || '';
        els.teacher.value = state.classInfo.teacherName || '';
        saveUserData();
        render();
        alert('âœ… ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­!');
      }catch(err){
        alert('âŒ Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­.');
      }
    };
    fr.readAsText(f, 'UTF-8');
    ev.target.value = '';
  });

  els.btnPrint.addEventListener('click', ()=>window.print());
  els.search.addEventListener('input', ()=>{ state.searchQuery = els.search.value.trim().toLowerCase(); renderTable(); });

  els.addBtn.addEventListener('click', addStudent);
  els.allPresent.addEventListener('click', ()=>setAllAttendance('Ø­Ø§Ø¶Ø±'));
  els.allAbsent.addEventListener('click', ()=>setAllAttendance('ØºØ§Ø¦Ø¨'));
  els.loginBtn.addEventListener('click', login);
  els.registerBtn.addEventListener('click', register);
  els.logoutBtn.addEventListener('click', logout);

  // Renderers
  function render(){
    // badge
    els.gradeBadge.innerHTML = state.classInfo.className
      ? `<div class="badge">âœ… ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ: <strong>${state.classInfo.className}</strong></div>`
      : '';
    renderTable();
    renderQuickStats();
    renderStyleStats();
    renderLevelStats();
  }

  function filtered(){
    if(!state.searchQuery) return state.students;
    return state.students.filter(s => (s.name||'').toLowerCase().includes(state.searchQuery));
  }

  function renderTable(){
    const rows = filtered().map((s, i)=>{
      // selects
      const styleSel = `<select data-id="${s.id}" data-field="learningStyle">${learningStyles.map(v=>`<option ${v===s.learningStyle?'selected':''}>${v}</option>`).join('')}</select>`;
      const attSel = `<select data-id="${s.id}" data-field="attendance">${attendanceOptions.map(v=>`<option ${v===s.attendance?'selected':''}>${v}</option>`).join('')}</select>`;
      const lvlSel = `<select data-id="${s.id}" data-field="level">${levelOptions.map(v=>`<option ${v===s.level?'selected':''}>${v}</option>`).join('')}</select>`;
      return `<tr>
        <td>${i+1}</td>
        <td><input class="input" data-id="${s.id}" data-field="name" value="${escapeHtml(s.name)}"/></td>
        <td>${styleSel}</td>
        <td>${attSel}</td>
        <td>${lvlSel}</td>
        <td class="no-print center"><button class="btn red small" data-del="${s.id}">ğŸ—‘ï¸ Ø­Ø°Ù</button></td>
      </tr>`;
    }).join('');
    els.tbody.innerHTML = rows || `<tr><td colspan="6" class="center muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`;

    // attach listeners
    els.tbody.querySelectorAll('button[data-del]').forEach(b=>{
      b.addEventListener('click', ()=> deleteStudent(Number(b.getAttribute('data-del'))));
    });
    els.tbody.querySelectorAll('input[data-field], select[data-field]').forEach(el=>{
      el.addEventListener('change', ()=>{
        const id = Number(el.getAttribute('data-id'));
        const field = el.getAttribute('data-field');
        updateField(id, field, el.value);
      });
    });
  }

  function renderQuickStats(){
    const total = state.students.length;
    const present = state.students.filter(s=>s.attendance==='Ø­Ø§Ø¶Ø±').length;
    const above = state.students.filter(s=>s.level==='ÙÙˆÙ‚ Ø§Ù„Ù…ØªÙˆØ³Ø·').length;
    els.quickStats.innerHTML = `
      <div class="stat"><div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</div><div style="font-size:28px;font-weight:900;color:#f97316">${total}</div></div>
      <div class="stat"><div>Ø§Ù„Ø­Ø§Ø¶Ø±ÙˆÙ†</div><div style="font-size:28px;font-weight:900;color:#10b981">${present}</div></div>
      <div class="stat"><div>ÙÙˆÙ‚ Ø§Ù„Ù…ØªÙˆØ³Ø·</div><div style="font-size:28px;font-weight:900;color:#f59e0b">${above}</div></div>
    `;
  }

  function countBy(arr, key){
    const m = {};
    arr.forEach(s=>{ const v = s[key]; m[v] = (m[v]||0)+1; });
    return m;
  }
  function pct(n, total){ total = total||1; return Math.round((n*100)/total); }
  function statCard(title, count, percent, colorClass){
    return `<div class="stat">
      <div class="row" style="justify-content:space-between">
        <div style="font-weight:800">${title}</div>
        <div class="muted">${count} Ø·Ø§Ù„Ø¨/Ø©</div>
      </div>
      <div class="progress" style="margin-top:8px">
        <div class="bar ${colorClass}" style="width:${percent}%"></div>
      </div>
      <div class="muted" style="text-align:left">${percent}%</div>
    </div>`;
  }

  function renderStyleStats(){
    const total = state.students.length || 1;
    // focus on four main categories
    const keys = ['Ø³Ù…Ø¹ÙŠ','Ø¨ØµØ±ÙŠ','Ù‚Ø±Ø§Ø¦ÙŠ/ÙƒØªØ§Ø¨ÙŠ','Ø­Ø±ÙƒÙŠ'];
    const counts = countBy(state.students,'learningStyle');
    els.styleStats.innerHTML = keys.map(k=>{
      const c = counts[k]||0;
      const p = pct(c,total);
      return statCard(k, c, p, 'purple');
    }).join('');
  }

  function renderLevelStats(){
    const total = state.students.length || 1;
    const keys = ['ÙÙˆÙ‚ Ø§Ù„Ù…ØªÙˆØ³Ø·','Ø¶Ù…Ù† Ø§Ù„Ù…ØªÙˆØ³Ø·','Ø¯ÙˆÙ† Ø§Ù„Ù…ØªÙˆØ³Ø·']; // render in this order
    const color = (k)=> k==='ÙÙˆÙ‚ Ø§Ù„Ù…ØªÙˆØ³Ø·' ? 'green' : (k==='Ø¶Ù…Ù† Ø§Ù„Ù…ØªÙˆØ³Ø·' ? 'yellow' : 'red');
    const counts = countBy(state.students,'level');
    els.levelStats.innerHTML = keys.map(k=> statCard(k, counts[k]||0, pct((counts[k]||0), total), color(k))).join('');
  }

  function escapeHtml(str){ return (str||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

  // init
  if(!tryAutoLogin()){ /* stay on login */ }
})();
</script>
</body>
</html>
